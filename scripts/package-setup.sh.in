#!/usr/bin/env bash
set -Eeuo pipefail
trap 'echo "ERROR: $BASH_SOURCE:$LINENO $BASH_COMMAND" >&2' ERR

readonly -a users=(
	'@AGENT_USER@'
	'@AUTH_DHCP_USER@'
	'@AUTH_DNS_USER@'
	'@DATABASE_USER@'
	'@PORTAL_USER@'
	'@RADIUS_USER@'
	'@UNAUTH_DNS_USER@'
)
readonly -A groups=(
	['@AGENT_USER@']='@AGENT_GROUP@'
	['@AUTH_DHCP_USER@']='@AUTH_DHCP_GROUP@'
	['@AUTH_DNS_USER@']='@AUTH_DNS_GROUP@'
	['@DATABASE_USER@']='@DATABASE_GROUP@'
	['@PORTAL_USER@']='@PORTAL_GROUP@'
	['@RADIUS_USER@']='@RADIUS_GROUP@'
	['@UNAUTH_DNS_USER@']='@UNAUTH_DNS_GROUP@'
)
readonly -A homes=(
	['@AGENT_USER@']='@AGENT_HOME@'
	['@AUTH_DHCP_USER@']='@AUTH_DHCP_HOME@'
	['@AUTH_DNS_USER@']='@AUTH_DNS_HOME@'
	['@DATABASE_USER@']='@DATABASE_HOME@'
	['@PORTAL_USER@']='@PORTAL_HOME@'
	['@RADIUS_USER@']='@RADIUS_HOME@'
	['@UNAUTH_DNS_USER@']='@UNAUTH_DNS_HOME@'
)

if ! getent group '@SYSTEM_GROUP@' &>/dev/null; then
	echo "Creating @SYSTEM_GROUP@ group ..."
	addgroup --quiet --system '@SYSTEM_GROUP@'
fi

if [[ $(stat --format='%G' '@pkgsysconfdir@') != '@SYSTEM_GROUP@' ]]; then
	chgrp -R '@SYSTEM_GROUP@' '@pkgsysconfdir@'
fi

for user in "${users[@]}"; do
	group="${groups[$user]}"
	home="${homes[$user]}"
	if ! getent group "$group" &>/dev/null; then
		echo "Creating $group group ..."
		addgroup --quiet --system "$group"
	fi
	if ! getent passwd "$user" &>/dev/null; then
		echo "Creating $user user ..."
		adduser --quiet --system --home "$home" --no-create-home --ingroup "$group" --disabled-password "$user"
		adduser --quiet "$user" '@SYSTEM_GROUP@'
		chown "$user":"$group" "$home"
		chmod o= "$home"
	fi
done
