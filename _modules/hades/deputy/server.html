
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Licensed under the Apache 2.0 License -->
  <link rel="stylesheet" type="text/css" href="../../../_static/fonts/open-sans/stylesheet.css" />
  <!-- Licensed under the SIL Open Font License -->
  <link rel="stylesheet" type="text/css" href="../../../_static/fonts/source-serif-pro/source-serif-pro.css" />
  <link rel="stylesheet" type="text/css" href="../../../_static/css/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="../../../_static/css/bootstrap-theme.min.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
    <title>hades.deputy.server &#8212; Hades 0.4.0-180-g86b2a9b documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/guzzle.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
   

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Hades 0.4.0-180-g86b2a9b documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hades.deputy.server</a></li> 
      </ul>
    </div>
    <div class="container-wrapper">

      <div id="mobile-toggle">
        <a href="#"><span class="glyphicon glyphicon-align-justify" aria-hidden="true"></span></a>
      </div>
  <div id="left-column">
    <div class="sphinxsidebar">
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <h2>Table Of Contents</h2>
  </div>
  <div class="sidebar-toc">
    
    
      <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../components.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking.html">Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../replication.html">Replication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../alternative-dns.html">Alternative DNS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli.html">CLI Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/hades.html">Code Documentation</a></li>
</ul>

    
  </div>
</div>
<div class="sidebar-block">
  <div class="sidebar-wrapper">
    <div id="main-search">
      <form class="form-inline" action="../../../search.html" method="GET" role="form">
        <div class="input-group">
          <input name="q" type="text" class="form-control" placeholder="Search...">
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div>
      
    </div>
  </div>
        <div id="right-column">
          
          <div role="navigation" aria-label="breadcrumbs navigation">
            <ol class="breadcrumb">
              <li><a href="../../../index.html">Docs</a></li>
              
                <li><a href="../../index.html">Module code</a></li>
              
              <li>hades.deputy.server</li>
            </ol>
          </div>
          
          <div class="document clearer body">
            
  <h1>Source code for hades.deputy.server</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Deputy daemon that provides a service via DBus for performing privileged</span>
<span class="sd">operations.</span>

<span class="sd">Some operations, such as generating configuration files, sending signals to</span>
<span class="sd">other processes etc. need certain privileges. The Deputy service runs as *root*</span>
<span class="sd">and provides a very simple service over DBus.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">textwrap</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">netaddr</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="c1"># noinspection PyPackageRequirements</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">GLib</span>
<span class="kn">from</span> <span class="nn">pydbus</span> <span class="kn">import</span> <span class="n">SystemBus</span>
<span class="kn">from</span> <span class="nn">pydbus.bus</span> <span class="kn">import</span> <span class="n">Bus</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">null</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.pool</span> <span class="kn">import</span> <span class="n">StaticPool</span>

<span class="kn">from</span> <span class="nn">hades</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">hades.common</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">hades.common.db</span> <span class="kn">import</span> <span class="n">get_auth_dhcp_lease_of_ip</span>
<span class="kn">from</span> <span class="nn">hades.common.dbus</span> <span class="kn">import</span> <span class="n">handle_glib_error</span>
<span class="kn">from</span> <span class="nn">hades.common.privileges</span> <span class="kn">import</span> <span class="n">dropped_privileges</span>
<span class="kn">from</span> <span class="nn">hades.config.loader</span> <span class="kn">import</span> <span class="n">Config</span><span class="p">,</span> <span class="n">get_config</span>
<span class="kn">from</span> <span class="nn">hades.deputy.dhcp</span> <span class="kn">import</span> <span class="n">release_dhcp_lease</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="reload_systemd_unit"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.reload_systemd_unit">[docs]</a><span class="k">def</span> <span class="nf">reload_systemd_unit</span><span class="p">(</span><span class="n">bus</span><span class="p">:</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Instruct systemd to reload a given unit.</span>

<span class="sd">    :param bus: A DBus Bus</span>
<span class="sd">    :param unit: The name of the systemd unit</span>
<span class="sd">    :param timeout: Timeout in milliseconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Instructing systemd to reload unit </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">systemd</span> <span class="o">=</span> <span class="n">bus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;org.freedesktop.systemd1&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">manager_interface</span> <span class="o">=</span> <span class="n">systemd</span><span class="p">[</span><span class="s1">&#39;org.freedesktop.systemd1.Manager&#39;</span><span class="p">]</span>
        <span class="n">manager_interface</span><span class="o">.</span><span class="n">ReloadUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">GLib</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">handle_glib_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="restart_systemd_unit"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.restart_systemd_unit">[docs]</a><span class="k">def</span> <span class="nf">restart_systemd_unit</span><span class="p">(</span><span class="n">bus</span><span class="p">:</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Instruct systemd to restart a given unit.</span>

<span class="sd">    :param bus: A DBus Bus</span>
<span class="sd">    :param unit: The name of the systemd unit</span>
<span class="sd">    :param timeout: Timeout in milliseconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Instructing systemd to restart unit </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">systemd</span> <span class="o">=</span> <span class="n">bus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;org.freedesktop.systemd1&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">manager_interface</span> <span class="o">=</span> <span class="n">systemd</span><span class="p">[</span><span class="s1">&#39;org.freedesktop.systemd1.Manager&#39;</span><span class="p">]</span>
        <span class="n">manager_interface</span><span class="o">.</span><span class="n">RestartUnit</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="s1">&#39;fail&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">GLib</span><span class="o">.</span><span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">handle_glib_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_dhcp_host_reservations"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.generate_dhcp_host_reservations">[docs]</a><span class="k">def</span> <span class="nf">generate_dhcp_host_reservations</span><span class="p">(</span>
        <span class="n">hosts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">netaddr</span><span class="o">.</span><span class="n">EUI</span><span class="p">,</span> <span class="n">netaddr</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Generate lines suitable for dnsmasq&#39;s ``--dhcp-hostsfile=`` option.</span>

<span class="sd">    :param hosts: The MAC address-IP address pairs of the hosts</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
        <span class="n">mac</span> <span class="o">=</span> <span class="n">netaddr</span><span class="o">.</span><span class="n">EUI</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span>
        <span class="n">mac</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">netaddr</span><span class="o">.</span><span class="n">mac_unix_expanded</span>
        <span class="k">yield</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">,id:*,</span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_dhcp_hosts_file"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.generate_dhcp_hosts_file">[docs]</a><span class="k">def</span> <span class="nf">generate_dhcp_hosts_file</span><span class="p">(</span>
        <span class="n">hosts</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">netaddr</span><span class="o">.</span><span class="n">EUI</span><span class="p">,</span> <span class="n">netaddr</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate the dnsmasq hosts file for authenticated users&quot;&quot;&quot;</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">AUTH_DHCP_HOSTS_FILE</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating DHCP hosts file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="n">auth_dhcp_pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">AUTH_DHCP_USER</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CLOEXEC</span><span class="p">,</span>
                     <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fchown</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">auth_dhcp_pwd</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">auth_dhcp_pwd</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fchmod</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">generate_dhcp_host_reservations</span><span class="p">(</span><span class="n">hosts</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error writing </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_ipset_swap"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.generate_ipset_swap">[docs]</a><span class="k">def</span> <span class="nf">generate_ipset_swap</span><span class="p">(</span><span class="n">ipset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tmp_ipset_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">ips</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">netaddr</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Generate an ``ipset`` script, that replaces an existing ``hash:ip`` ipset</span>
<span class="sd">    with new contents.</span>

<span class="sd">    :param ipset_name: The ipset to replace</span>
<span class="sd">    :param tmp_ipset_name: Name of the temporary ipset</span>
<span class="sd">    :param ips: The new contents of the ipset</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">yield</span> <span class="s1">&#39;create </span><span class="si">{}</span><span class="s1"> hash:ip -exist</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_ipset_name</span><span class="p">)</span>
    <span class="k">yield</span> <span class="s1">&#39;flush </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_ipset_name</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="nb">map</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="s1">&#39;add </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">tmp_ipset_name</span><span class="p">),</span> <span class="n">ips</span><span class="p">)</span>
    <span class="k">yield</span> <span class="s1">&#39;swap </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ipset_name</span><span class="p">,</span> <span class="n">tmp_ipset_name</span><span class="p">)</span>
    <span class="k">yield</span> <span class="s1">&#39;destroy </span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmp_ipset_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="update_alternative_dns_ipset"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.update_alternative_dns_ipset">[docs]</a><span class="k">def</span> <span class="nf">update_alternative_dns_ipset</span><span class="p">(</span><span class="n">ips</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">netaddr</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Update the *alternative DNS ipset* with the new IP addresses</span>

<span class="sd">    :param ips: The new IP addresses</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="n">ipset_name</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s1">&#39;HADES_AUTH_DNS_ALTERNATIVE_IPSET&#39;</span><span class="p">]</span>
    <span class="n">tmp_ipset_name</span> <span class="o">=</span> <span class="s1">&#39;tmp_&#39;</span> <span class="o">+</span> <span class="n">ipset_name</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating alternative_dns ipset (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">ipset_name</span><span class="p">)</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(),</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">generate_ipset_swap</span><span class="p">(</span><span class="n">ipset_name</span><span class="p">,</span> <span class="n">tmp_ipset_name</span><span class="p">,</span> <span class="n">ips</span><span class="p">))</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="p">[</span><span class="n">constants</span><span class="o">.</span><span class="n">IP</span><span class="p">,</span> <span class="s1">&#39;netns&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="s1">&#39;auth&#39;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">IPSET</span><span class="p">,</span> <span class="s1">&#39;restore&#39;</span><span class="p">],</span>
        <span class="nb">input</span><span class="o">=</span><span class="n">commands</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span></div>


<div class="viewcode-block" id="generate_radius_clients"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.generate_radius_clients">[docs]</a><span class="k">def</span> <span class="nf">generate_radius_clients</span><span class="p">(</span>
        <span class="n">clients</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Generate the FreeRADIUS configuration for a given list of NAS clients in</span>
<span class="sd">    the ``clients.conf`` format.</span>

<span class="sd">    :param clients: An iterable of (Shortname, NAS-Name, NAS-Type, Port, Secret,</span>
<span class="sd">     Server, Community, Description)-tuples. Currently only shortname NAS-Name,</span>
<span class="sd">     NAS-Type and the Secret elements are used.</span>
<span class="sd">    :return: configuration snippets for the given NAS clients</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">escape_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([&quot;</span><span class="se">\\</span><span class="s1">])&#39;</span><span class="p">)</span>
    <span class="n">replacement</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">\1&#39;</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">textwrap</span><span class="o">.</span><span class="n">dedent</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        client $shortname {</span>
<span class="s2">            shortname = &quot;$shortname&quot;</span>
<span class="s2">            ipaddr = &quot;$nasname&quot;</span>
<span class="s2">            secret = &quot;$secret&quot;</span>
<span class="s2">            require_message_authenticator = no</span>
<span class="s2">            nastype = $type</span>
<span class="s2">            coa_server = &quot;$shortname&quot;</span>
<span class="s2">        }</span>
<span class="s2">        home_server $shortname {</span>
<span class="s2">            type = coa</span>
<span class="s2">            ipaddr = &quot;$nasname&quot;</span>
<span class="s2">            port = 3799</span>
<span class="s2">            secret = &quot;$secret&quot;</span>
<span class="s2">            coa {</span>
<span class="s2">                irt = 2</span>
<span class="s2">                mrt = 16</span>
<span class="s2">                mrc = 5</span>
<span class="s2">                mrd = 30</span>
<span class="s2">            }</span>
<span class="s2">        }</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">shortname</span><span class="p">,</span> <span class="n">nasname</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">ports</span><span class="p">,</span> <span class="n">secret</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">community</span><span class="p">,</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">clients</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span>
            <span class="n">shortname</span><span class="o">=</span><span class="n">shortname</span><span class="p">,</span> <span class="n">nasname</span><span class="o">=</span><span class="n">nasname</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">ports</span><span class="o">=</span><span class="n">ports</span><span class="p">,</span>
            <span class="n">secret</span><span class="o">=</span><span class="n">escape_pattern</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">replacement</span><span class="p">,</span> <span class="n">secret</span><span class="p">),</span> <span class="n">community</span><span class="o">=</span><span class="n">community</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_radius_clients_file"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.generate_radius_clients_file">[docs]</a><span class="k">def</span> <span class="nf">generate_radius_clients_file</span><span class="p">(</span>
        <span class="n">clients</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Generate a FreeRADIUS ``clients.conf`` file.</span>

<span class="sd">    :param clients: See :func:`generate_radius_clients` for a description</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Generating freeRADIUS clients configuration&quot;</span><span class="p">)</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">RADIUS_CLIENTS_FILE</span>
    <span class="n">radius_pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">RADIUS_USER</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fchown</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">radius_pwd</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">radius_pwd</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">fchmod</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">generate_radius_clients</span><span class="p">(</span><span class="n">clients</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error writing </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span></div>


<div class="viewcode-block" id="HadesDeputyService"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.HadesDeputyService">[docs]</a><span class="k">class</span> <span class="nc">HadesDeputyService</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deputy DBus service</span>

<span class="sd">    This class implements a DBus service that exposes some privileged operations</span>
<span class="sd">    for use by the :mod:`hades.agent` or the periodic systemd timer services.</span>

<span class="sd">    For security reasons, the service doesn&#39;t accept data from the DBus clients</span>
<span class="sd">    and always queries the database itself, so that this service can&#39;t be</span>
<span class="sd">    misused.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbus</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_string</span><span class="p">(</span>
        <span class="n">__package__</span><span class="p">,</span> <span class="s1">&#39;interface.xml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;DBus object introspection specification&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bus</span><span class="p">:</span> <span class="n">Bus</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param bus: The bus (typically the system bus)</span>
<span class="sd">        :param config: The configuration object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">poolclass</span><span class="o">=</span><span class="n">StaticPool</span><span class="p">)</span>
        <span class="n">database_pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DATABASE_USER</span><span class="p">)</span>
        <span class="n">original_creator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_creator</span>

        <span class="k">def</span> <span class="nf">creator</span><span class="p">(</span><span class="n">connection_record</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Create a connection as the database user&quot;&quot;&quot;</span>
            <span class="k">with</span> <span class="n">dropped_privileges</span><span class="p">(</span><span class="n">database_pwd</span><span class="p">):</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">original_creator</span><span class="p">(</span><span class="n">connection_record</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">connection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">_creator</span> <span class="o">=</span> <span class="n">creator</span>

<div class="viewcode-block" id="HadesDeputyService.Refresh"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.HadesDeputyService.Refresh">[docs]</a>    <span class="k">def</span> <span class="nf">Refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">force</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Refresh the materialized views.</span>

<span class="sd">        If necessary depended config files are regenerate and the corresponding</span>
<span class="sd">        services are reloaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Refreshing materialized views&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
                <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">radcheck</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">radreply</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">radgroupcheck</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">radgroupreply</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">radusergroup</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">connection</span><span class="o">.</span><span class="n">begin</span><span class="p">():</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">dhcphost</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">nas</span><span class="p">)</span>
                    <span class="n">db</span><span class="o">.</span><span class="n">refresh_materialized_view</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">alternative_dns</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Forcing reload of DHCP hosts, NAS clients and &quot;</span>
                            <span class="s2">&quot;alternative DNS clients&quot;</span><span class="p">)</span>
                <span class="n">reload_dhcp_host</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">reload_nas</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">reload_alternative_dns</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">hosts</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_dhcp_hosts</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="n">clients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_nas_clients</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                <span class="n">ips</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_alternative_dns_ips</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dhcphost_diff</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh_and_diff_materialized_view</span><span class="p">(</span>
                    <span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">dhcphost</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">temp_dhcphost</span><span class="p">,</span> <span class="p">[</span><span class="n">null</span><span class="p">()])</span>
                <span class="k">if</span> <span class="n">dhcphost_diff</span> <span class="o">!=</span> <span class="p">([],</span> <span class="p">[],</span> <span class="p">[]):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;DHCP host reservations changed &#39;</span>
                                <span class="s1">&#39;(</span><span class="si">%d</span><span class="s1"> added, </span><span class="si">%d</span><span class="s1"> deleted, </span><span class="si">%d</span><span class="s1"> modified).&#39;</span><span class="p">,</span>
                                <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">dhcphost_diff</span><span class="p">))</span>
                    <span class="n">hosts</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_dhcp_hosts</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                    <span class="n">reload_dhcp_host</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reload_dhcp_host</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">nas_diff</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh_and_diff_materialized_view</span><span class="p">(</span>
                    <span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">nas</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">temp_nas</span><span class="p">,</span> <span class="p">[</span><span class="n">null</span><span class="p">()])</span>

                <span class="k">if</span> <span class="n">nas_diff</span> <span class="o">!=</span> <span class="p">([],</span> <span class="p">[],</span> <span class="p">[]):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;RADIUS clients changed &#39;</span>
                                <span class="s1">&#39;(</span><span class="si">%d</span><span class="s1"> added, </span><span class="si">%d</span><span class="s1"> deleted, </span><span class="si">%d</span><span class="s1"> modified).&#39;</span><span class="p">,</span>
                                <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">nas_diff</span><span class="p">))</span>
                    <span class="n">clients</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_nas_clients</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                    <span class="n">reload_nas</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reload_nas</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">alternative_dns_diff</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh_and_diff_materialized_view</span><span class="p">(</span>
                    <span class="n">connection</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">alternative_dns</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">temp_alternative_dns</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">null</span><span class="p">()])</span>

                <span class="k">if</span> <span class="n">alternative_dns_diff</span> <span class="o">!=</span> <span class="p">([],</span> <span class="p">[],</span> <span class="p">[]):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Alternative auth DNS clients changed &#39;</span>
                                <span class="s1">&#39;(</span><span class="si">%d</span><span class="s1"> added, </span><span class="si">%d</span><span class="s1"> deleted, </span><span class="si">%d</span><span class="s1"> modified).&#39;</span><span class="p">,</span>
                                <span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">alternative_dns_diff</span><span class="p">))</span>
                    <span class="n">ips</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">get_all_alternative_dns_ips</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>
                    <span class="n">reload_alternative_dns</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">reload_alternative_dns</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">reload_dhcp_host</span><span class="p">:</span>
            <span class="n">generate_dhcp_hosts_file</span><span class="p">(</span><span class="n">hosts</span><span class="p">)</span>
            <span class="n">reload_systemd_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="p">,</span> <span class="s1">&#39;hades-auth-dhcp.service&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reload_nas</span><span class="p">:</span>
            <span class="n">generate_radius_clients_file</span><span class="p">(</span><span class="n">clients</span><span class="p">)</span>
            <span class="n">restart_systemd_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bus</span><span class="p">,</span> <span class="s1">&#39;hades-radius.service&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reload_alternative_dns</span><span class="p">:</span>
            <span class="n">update_alternative_dns_ipset</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;OK&quot;</span></div>

<div class="viewcode-block" id="HadesDeputyService.Cleanup"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.HadesDeputyService.Cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">Cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Clean up old records in the ``radacct`` and ``radpostauth`` tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaning up old records&quot;</span><span class="p">)</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">HADES_RETENTION_INTERVAL</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">delete_old_sessions</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">delete_old_auth_attempts</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;OK&quot;</span></div>

<div class="viewcode-block" id="HadesDeputyService.ReleaseAuthDhcpLease"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.HadesDeputyService.ReleaseAuthDhcpLease">[docs]</a>    <span class="k">def</span> <span class="nf">ReleaseAuthDhcpLease</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Release a DHCP lease</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Releasing DHCP lease for client </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_ip</span> <span class="o">=</span> <span class="n">netaddr</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ERROR: Illegal IP address </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">client_ip</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">())</span> <span class="k">as</span> <span class="n">connection</span><span class="p">:</span>
            <span class="n">lease_info</span> <span class="o">=</span> <span class="n">get_auth_dhcp_lease_of_ip</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lease_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No lease for </span><span class="si">%s</span><span class="s2"> found&quot;</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">)</span>
                <span class="k">return</span> <span class="s2">&quot;OK&quot;</span>
            <span class="n">expiry_time</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">client_id</span> <span class="o">=</span> <span class="n">lease_info</span>
            <span class="n">server_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">HADES_AUTH_LISTEN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">release_dhcp_lease</span><span class="p">(</span><span class="n">server_ip</span><span class="p">,</span> <span class="n">client_ip</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">client_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;OK&quot;</span></div></div>


<div class="viewcode-block" id="run_event_loop"><a class="viewcode-back" href="../../../api/hades.deputy.html#hades.deputy.server.run_event_loop">[docs]</a><span class="k">def</span> <span class="nf">run_event_loop</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Run the DBus :class:`HadesDeputyService` on the GLib event loop.&quot;&quot;&quot;</span>
    <span class="n">bus</span> <span class="o">=</span> <span class="n">SystemBus</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Publishing interface </span><span class="si">%s</span><span class="s1"> on DBus&#39;</span><span class="p">,</span> <span class="n">constants</span><span class="o">.</span><span class="n">DEPUTY_DBUS_NAME</span><span class="p">)</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()</span>
    <span class="n">bus</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DEPUTY_DBUS_NAME</span><span class="p">,</span> <span class="n">HadesDeputyService</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">config</span><span class="p">))</span>
    <span class="n">loop</span> <span class="o">=</span> <span class="n">GLib</span><span class="o">.</span><span class="n">MainLoop</span><span class="p">()</span>
    <span class="n">loop</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>
</pre></div>

          </div>
            
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Hades 0.4.0-180-g86b2a9b documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hades.deputy.server</a></li> 
      </ul>
    </div>
<script type="text/javascript">
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script>
<script type="text/javascript" src="../../../_static/js/bootstrap.js"></script>
  <div class="footer">
    &copy; Copyright 2015-2020, Sebastian Schrader, Stefan Haller. Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
  </div>
  </body>
</html>